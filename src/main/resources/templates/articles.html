<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Quản lý Articles</title>

    <!-- Bootstrap CSS (phiên bản 5.3 mới nhất) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .thumbnail {
            width: 80px;
            height: auto;
        }
        .actions a {
            margin: 0 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container mt-4">

    <h1 class="text-center mb-4">Danh sách Bài Viết</h1>

    <div class="mb-3 text-center">
        <button class="btn btn-success" id="btnAdd" data-bs-toggle="modal" data-bs-target="#modalArticle">Thêm mới Bài Viết</button>
    </div>

    <table class="table table-bordered table-hover">
        <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Tiêu đề</th>
            <th>Mô tả</th>
            <th>Nội Dung</th>
            <th>Ngày tạo</th>
            <th>Ngày cập nhật</th>
            <th>Ảnh</th>
            <th>Người đăng (Email)</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="article : ${articles}" 
            th:data-articleid="${article.articleId}"
            th:data-title="${article.title}"
            th:data-description="${article.description}"
            th:data-content="${article.content}"
            th:data-userid="${article.userId}"
            th:data-imageurl="${article.image_Url}">
            <td th:text="${article.articleId}">1</td>
            <td th:text="${article.title}">Tiêu đề</td>
            <td th:text="${article.description}">Mô tả</td>
            <td th:text="${article.content}">Nội dung</td>
            <td th:text="${article.createdAt != null ? #temporals.format(article.createdAt, 'dd-MM-yyyy HH:mm') : ''}"></td>
            <td th:text="${article.updatedAt != null ? #temporals.format(article.updatedAt, 'dd-MM-yyyy HH:mm') : ''}"></td>
            <td>
                <img th:if="${article.image_Url != null}" th:src="@{${article.image_Url}}" class="thumbnail" />
            </td>
            <td th:text="${userEmails != null && userEmails.containsKey(article.userId) ? userEmails[article.userId] : 'Unknown'}"></td>
            <td class="actions">
                <a href="#" class="btn btn-primary btn-sm btnEdit">Sửa</a>
                <a th:href="@{'/articles/delete/' + ${article.articleId}}" 
                   class="btn btn-danger btn-sm"
                   onclick="return confirm('Bạn có chắc chắn muốn xóa?');">Xóa</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Modal chung cho Add & Edit -->
<div class="modal fade" id="modalArticle" tabindex="-1" aria-labelledby="modalArticleLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form th:action="@{/articles/add}" method="post" enctype="multipart/form-data" th:object="${article}" id="formArticle">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalArticleLabel">Thêm mới Bài Viết</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" th:field="*{articleId}" id="articleId" name="articleId" />

                    <div class="mb-3">
                        <label for="title" class="form-label">Tiêu đề:</label>
                        <input type="text" id="title" th:field="*{title}" name="title" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Mô tả:</label>
                        <textarea id="description" th:field="*{description}" name="description" rows="3" class="form-control"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">Nội dung:</label>
                        <textarea id="content" th:field="*{content}" name="content" rows="6" class="form-control" required></textarea>
                    </div>

                    <div class="mb-3" id="currentImageDiv" style="display:none;">
                        <label class="form-label">Ảnh hiện tại:</label><br/>
                        <img src="" alt="Ảnh bài viết" id="currentImage" class="thumbnail" />
                    </div>

                    <div class="mb-3">
                        <label for="imageFile" class="form-label">Ảnh (file):</label>
                        <input type="file" id="imageFile" name="imageFile" accept="image/*" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label for="userId" class="form-label">Người đăng (Admin email):</label>
                        <select th:field="*{userId}" name="userId" id="userId" class="form-select" required>
                            <option value="" disabled>-- Chọn Email Admin --</option>
                            <option th:each="user : ${users}" th:value="${user.userId}" th:text="${user.email}"></option>
                        </select>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success" id="btnSubmit">Thêm mới</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                </div>
            </form>
        </div>
    </div>
    
</div>
<div class="mb-3 text-center">
    <a href="/dashboard" class="btn btn-secondary ms-2">Quay lại Dashboard</a>
</div>

<!-- Bootstrap JS + Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const modal = new bootstrap.Modal(document.getElementById('modalArticle'));
    const form = document.getElementById('formArticle');
    const modalTitle = document.getElementById('modalArticleLabel');
    const btnSubmit = document.getElementById('btnSubmit');
    const articleIdInput = document.getElementById('articleId');
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    const contentInput = document.getElementById('content');
    const userIdSelect = document.getElementById('userId');
    const currentImageDiv = document.getElementById('currentImageDiv');
    const currentImage = document.getElementById('currentImage');
    const imageFileInput = document.getElementById('imageFile');

    // Khi click nút Thêm mới
    document.getElementById('btnAdd').addEventListener('click', () => {
        modalTitle.textContent = 'Thêm mới Bài Viết';
        btnSubmit.textContent = 'Thêm mới';
        form.action = /*[[@{/articles/add}]]*/ '/articles/add';  // Thymeleaf replace

        // Reset form
        articleIdInput.value = '';
        titleInput.value = '';
        descriptionInput.value = '';
        contentInput.value = '';
        userIdSelect.value = '';
        imageFileInput.value = '';
        currentImageDiv.style.display = 'none';
    });

    // Khi click nút Sửa
    document.querySelectorAll('.btnEdit').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();

            const tr = this.closest('tr');

            // Lấy data attribute từ row
            const articleId = tr.getAttribute('data-articleid');
            const title = tr.getAttribute('data-title');
            const description = tr.getAttribute('data-description');
            const content = tr.getAttribute('data-content');
            const userId = tr.getAttribute('data-userid');
            const imageUrl = tr.getAttribute('data-imageurl');

            modalTitle.textContent = 'Chỉnh sửa Bài Viết';
            btnSubmit.textContent = 'Lưu thay đổi';
            form.action = /*[[@{/articles/edit}]]*/ '/articles/edit';  // Thymeleaf replace

            // Điền dữ liệu vào form
            articleIdInput.value = articleId;
            titleInput.value = title;
            descriptionInput.value = description;
            contentInput.value = content;
            userIdSelect.value = userId;
            imageFileInput.value = '';

            if(imageUrl){
                currentImage.src = imageUrl;
                currentImageDiv.style.display = 'block';
            } else {
                currentImageDiv.style.display = 'none';
            }

            modal.show();
        });
    });

</script>

</body>
</html>
